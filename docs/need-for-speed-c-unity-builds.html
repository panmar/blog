<!DOCTYPE html>

<html lang="en">
<head>
<title>Marcin Panasiuk - blog</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/site.webmanifest" rel="manifest"/>
<link href="/theme/main.css" rel="stylesheet" type="text/css"/>
<link href="/theme/highlight.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.marcinpanasiuk.com/feeds/all.atom.xml" rel="alternate" title="Marcin Panasiuk - blog Full Atom Feed" type="application/atom+xml">
</link></head>
<body>
<div id="logo">
<a href="/">Marcin Panasiuk - blog</a>
</div>
<nav>
<a class="active" href="/">Posts</a>
        |
        <a href="/tags.html">Tags</a>
        |
        <a href="/pages/contact.html">Contact</a>
        |
        <a href="/feeds/all.atom.xml">Atom</a>
</nav>
<div id="content">
<div id="innercontent">
<h1>Need for speed: C++ unity builds</h1>
<header>
  Published on <time datetime="2022-05-16T19:51:00+02:00">2022-05-16</time>.
    Tagged with
      <a href="/tag/c.html">c++</a>.
</header>
<p>As I type these words, I'm staring at the LLVM compilation screen, which has been running for about an hour. What a waste of energy. I really hate long compilation times.</p>
<p>To address this issue, I started using <a class="reference external" href="https://en.wikipedia.org/wiki/Unity_build">unity builds</a>. They consolidate all code into a single translation unit. How much time can I save by organizing the code in this manner? I wrote <a class="reference external" href="https://github.com/panmar/unity-builds-cmp/">a simple test</a> where I generated 10,000 files:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;set&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;random&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTestClazzX</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"Hello from class "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MyTestClassX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">": "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>I then performed different compilations. Here are the results:</p>
<div class="highlight"><pre><span></span>➜<span class="w">  </span>unity-builds-cmp<span class="w"> </span>git:<span class="o">(</span>main<span class="o">)</span><span class="w"> </span>✗<span class="w"> </span>python<span class="w"> </span>test_unity_build.py<span class="w"> </span><span class="m">10000</span>
Cleaning<span class="w"> </span>src/<span class="w"> </span>directory
Generating<span class="w"> </span><span class="m">10000</span><span class="w"> </span>files...
Compiling<span class="w"> </span>unity<span class="w"> </span>build...<span class="w"> </span><span class="o">[</span>g++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">20</span>.84<span class="w"> </span>seconds
Compiling<span class="w"> </span>unity<span class="w"> </span>build<span class="w"> </span>using...<span class="w"> </span><span class="o">[</span>clang++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">10</span>.60<span class="w"> </span>seconds
Compiling<span class="w"> </span>normal<span class="w"> </span>build<span class="w"> </span>using<span class="w"> </span><span class="m">12</span><span class="w"> </span>cores...<span class="w"> </span><span class="o">[</span>clang++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">916</span>.86<span class="w"> </span>seconds
</pre></div>
<p>The single-threaded unity build was about 90 times faster than the normal one, even though the normal build was utilizing multiple cores. Of course, the exact results are artifical and depend very much on the files you are compiling, but the sheer difference is astonishing.</p>
<p>I use unity builds for my private projects, which consist usually of no more than 100 files. Here are the results for 100:</p>
<div class="highlight"><pre><span></span>➜<span class="w">  </span>unity-builds-cmp<span class="w"> </span>git:<span class="o">(</span>main<span class="o">)</span><span class="w"> </span>✗<span class="w"> </span>python<span class="w"> </span>test_unity_build.py<span class="w"> </span><span class="m">100</span>
Cleaning<span class="w"> </span>src/<span class="w"> </span>directory
Generating<span class="w"> </span><span class="m">100</span><span class="w"> </span>files...
Compiling<span class="w"> </span>unity<span class="w"> </span>build...<span class="w"> </span><span class="o">[</span>g++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">0</span>.64<span class="w"> </span>seconds
Compiling<span class="w"> </span>unity<span class="w"> </span>build<span class="w"> </span>using...<span class="w"> </span><span class="o">[</span>clang++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">0</span>.58<span class="w"> </span>seconds
Compiling<span class="w"> </span>normal<span class="w"> </span>build<span class="w"> </span>using<span class="w"> </span><span class="m">12</span><span class="w"> </span>cores...<span class="w"> </span><span class="o">[</span>clang++<span class="o">]</span>
<span class="w">    </span>DONE.<span class="w"> </span>The<span class="w"> </span>process<span class="w"> </span>took<span class="w"> </span><span class="m">7</span>.48<span class="w"> </span>seconds
</pre></div>
<p>About 13 times faster. This is noticeable and definitely worthwhile for me.</p>
<p>So, what about cons? Certainly, putting everything into a single translation unit can result in a big mess. For your own code, you can divide it into modules with their own namespaces and be very cautious about any macro usage. The external code poses more challenges. You could compile it into a separate library and provide simplified API if you want to keep namespace super clean. Alternatively, for a small project, you might just include it directly.</p>
<p>You can learn more about unity builds from <a class="reference external" href="https://onqtam.com/programming/2018-07-07-unity-builds/">Viktor Kirilov</a>.</p>
<hr class="before-footer"/>
<footer>
                Generated from <a href="https://github.com/panmar/blog/commit/f24e2c9">commit f24e2c9</a> on <nobr>2025-02-04 09:55:17+01:00</nobr>.
                Content licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.
            </footer>
</div>
</div>
</body>
</html>